# .github/workflows/release.yml
# This workflow handles the versioning, building, and release of the Angular application.
# It is manually triggered and analogous to the provided Gradle release pipeline.

name: Release Angular App

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version increment type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
          - custom
      custom_version:
        description: 'Custom version (e.g., 1.2.3) - required if type is custom'
        required: false
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean
      draft:
        description: 'Create as draft release'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  packages: write

jobs:
  # =================================================================
  # Job 1: Version, Build, and Tag
  # This job updates the version, builds the artifact, and pushes the tag.
  # =================================================================
  release:
    name: üöÄ Version and Build
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      timestamp: ${{ steps.build_info.outputs.timestamp }}
      artifact-name: ${{ steps.build_info.outputs.artifact-name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Use a token with write permissions to push the version bump
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: 'npm'

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install dependencies
        run: npm ci

      - name: Bump version and create tag
        id: version
        run: |
          VERSION_TYPE="${{ github.event.inputs.version_type }}"
          CUSTOM_VERSION="${{ github.event.inputs.custom_version }}"

          if [[ "$VERSION_TYPE" == "custom" ]]; then
            if [ -z "$CUSTOM_VERSION" ]; then
              echo "Error: A custom version must be provided when type is 'custom'."
              exit 1
            fi
            # Use npm version with the custom version string
            npm version --no-git-tag-version "$CUSTOM_VERSION"
          else
            # Use npm version with patch, minor, or major
            npm version --no-git-tag-version "$VERSION_TYPE"
          fi

          # Get the new version from package.json
          NEW_VERSION=$(node -p "require('./package.json').version")
          TAG="v$NEW_VERSION"

          echo "New version: $NEW_VERSION"
          echo "Creating tag: $TAG"

          # Manually create commit and tag
          git add package.json package-lock.json
          git commit -m "chore(release): version $NEW_VERSION"
          git tag "$TAG"

          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Push changes and tags
        run: |
          git push
          git push origin ${{ steps.version.outputs.tag }}

      - name: Build production application
        run: npx ng build --configuration production

      - name: Prepare build information
        id: build_info
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          ARTIFACT_NAME="porturl-frontend-${{ steps.version.outputs.tag }}.zip"
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "artifact-name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT

      - name: Archive production build
        run: |
          cd dist/porturl-frontend
          zip -r ../../${{ steps.build_info.outputs.artifact-name }} .

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: ${{ steps.build_info.outputs.artifact-name }}
          retention-days: 7

  # =================================================================
  # Job 2: Build and Push Docker Image
  # =================================================================
  docker:
    name: üê≥ Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: release
    steps:
      - name: Checkout release tag
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.release.outputs.tag }}

      - name: Set up QEMU & Docker Buildx
        uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Prepare Docker tags
        id: docker_tags
        run: |
          IMAGE_NAME="friesoft/porturl-frontend"
          VERSION="${{ needs.release.outputs.version }}"
          IS_PRERELEASE="${{ github.event.inputs.prerelease }}"

          TAGS="$IMAGE_NAME:$VERSION"

          # Add 'latest' and 'major.minor' tags only for stable releases
          if [ "$IS_PRERELEASE" != "true" ]; then
            TAGS="$TAGS,$IMAGE_NAME:latest"
            MAJOR_MINOR=$(echo "$VERSION" | cut -d. -f1,2)
            TAGS="$TAGS,$IMAGE_NAME:$MAJOR_MINOR"
          fi

          echo "tags=$TAGS" >> $GITHUB_OUTPUT
          echo "Docker tags: $TAGS"

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.docker_tags.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          labels: |
            org.opencontainers.image.title=porturl-frontend
            org.opencontainers.image.version=${{ needs.release.outputs.version }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ needs.release.outputs.timestamp }}

  # =================================================================
  # Job 3: Create GitHub Release
  # =================================================================
  github-release:
    name: üì¶ Create GitHub Release
    runs-on: ubuntu-latest
    needs: [release, docker]
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-artifact
          path: .

      - name: Generate Changelog
        id: changelog
        run: |
          # We need to check out the code to use git log
          git clone https://github.com/${{ github.repository }}.git
          cd ${{ github.repository.name }}

          # Get previous tag for changelog generation
          PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -v "${{ needs.release.outputs.tag }}" | head -n1 || echo "")

          if [ -n "$PREVIOUS_TAG" ]; then
            echo "Generating changelog from $PREVIOUS_TAG to ${{ needs.release.outputs.tag }}"
            # Use a temporary file for the changelog body
            CHANGELOG_BODY=$(git log --pretty=format:"- %s (%h)" "$PREVIOUS_TAG..${{ needs.release.outputs.tag }}")
            echo "changelog<<EOF" >> $GITHUB_ENV
            echo "## Changes" >> $GITHUB_ENV
            echo "$CHANGELOG_BODY" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "No previous tag found, skipping changelog generation."
          fi

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ needs.release.outputs.tag }}
          name: "Release ${{ needs.release.outputs.tag }}"
          draft: ${{ github.event.inputs.draft == 'true' }}
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          body: |
            ## üöÄ Release ${{ needs.release.outputs.version }}

            **Built:** `${{ needs.release.outputs.timestamp }}`

            ${{ env.changelog }}

            ### üê≥ Docker Image

            `docker pull friesoft/porturl-frontend:${{ needs.release.outputs.version }}`
          artifacts: "${{ needs.release.outputs.artifact-name }}"
          token: ${{ secrets.GITHUB_TOKEN }}
          makeLatest: ${{ github.event.inputs.prerelease != 'true' }}
